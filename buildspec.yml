version: 0.2

env:
  variables:
    CHILD_TEMPLATES: |
      sema4-vpc.yaml
      aws-genomics-s3.template.yaml
      aws-genomics-iam.template.yaml
      aws-genomics-launch-template.template.yaml
      aws-genomics-batch.template.yaml
      aws-cromwell-server.template.yaml
      sema4-serverless-rdb.yaml
    TEMPLATE_FILES: |
      sema4-valinor.yaml
      sema4-vpc.yaml
      aws-genomics-s3.template.yaml
      aws-genomics-iam.template.yaml
      aws-genomics-launch-template.template.yaml
      aws-genomics-batch.template.yaml
      aws-cromwell-server.template.yaml
      sema4-serverless-rdb.yaml
    CONFIG_FILES: |
      config-*.json

phases:
  install:
    commands:
      npm install jsonlint -g
  pre_build:
    commands:
      - echo "Validating Valinor templates"
      - |
        for template in $TEMPLATE_FILES; do
          echo "Validating CloudFormation template file $template"
          aws cloudformation validate-template --template-body file://$template
        done
      - |
        for conf in $CONFIG_FILES; do
          echo "Validating CF parameters config file $conf"
          jsonlint -q $conf
        done
  build:
    commands:
      - echo "Copying child stack templates to S3"
      - |
        for child_template in $CHILD_TEMPLATES; do
          if [ "X$TEMPLATE_PREFIX" = "X" ]; then
            aws s3 cp "$child_template" "s3://$TEMPLATE_BUCKET/$child_template" --sse aws:kms
          else
            aws s3 cp "$child_template" "s3://$TEMPLATE_BUCKET/$TEMPLATE_PREFIX/$child_template" --sse aws:kms
          fi
        done
      - echo "Updating template configuration files to use the appropriate values"
      - |
        for conf in $CONFIG_FILES; do
          if [ "X$TEMPLATE_PREFIX" = "X" ]; then
            echo "Replacing \"TEMPLATE_PATH_PLACEHOLDER\" for \"$TEMPLATE_BUCKET\" in $conf"
            sed -i -e "s/TEMPLATE_PATH_PLACEHOLDER/$TEMPLATE_BUCKET/" $conf
          else
            echo "Replacing \"TEMPLATE_PATH_PLACEHOLDER\" for \"$TEMPLATE_BUCKET/$TEMPLATE_PREFIX\" in $conf"
            sed -i -e "s/TEMPLATE_PATH_PLACEHOLDER/$TEMPLATE_BUCKET\/$TEMPLATE_PREFIX/" $conf
          fi
          echo "DB_HOST_PARAM: $DB_HOST_PARAM and CROMWELL_SERVER_URL_PARAM: $CROMWELL_SERVER_URL_PARAM"
          sed -i -e "s/CROMWELL_ROOT_PLACEHOLDER/$CROMWELL_ROOT/" $conf
          sed -i -e "s/DB_HOST_PLACEHOLDER/$DB_HOST_PARAM/" $conf
          echo "DB_USER_PARAM: $DB_USER_PARAM and DB_PASSWORD_PARAM: $DB_PASSWORD_PARAM"
          sed -i -e "s/DB_USER_PLACEHOLDER/$DB_USER_PARAM/" $conf
          sed -i -e "s/DB_PASSWORD_PLACEHOLDER/$DB_PASSWORD_PARAM/" $conf
          echo "CROMWELL_SERVER_URL_PARAM: $CROMWELL_SERVER_URL_PARAM CROSS_ACCOUNT_ROLE: $CROSS_ACCOUNT_ROLE"
          sed -i -e "s/CROMWELL_SERVER_URL_PLACEHOLDER/$CROMWELL_SERVER_URL_PARAM/" $conf
          sed -i -e "s/WORKFLOW_LOG_PLACEHOLDER/$WORKFLOW_LOG_DIR_NAME/" $conf
          sed -i -e "s|CROSS_ACCOUNT_ROLE_PLACEHOLDER|$CROSS_ACCOUNT_ROLE|" $conf
        done

artifacts:
  files:
    - sema4-valinor.yaml
    - config-*.json
